<script>
    async function translateBatch(targetLang, texts) {
        const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLang}&tl=${targetLang}&dt=t&q=${encodeURIComponent(texts.join("\n"))}`;
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Network error');
            const result = await response.json();

            return result[0].map(item => item?.[0] || "Translation Failed"); // Tránh lỗi undefined
        } catch (error) {
            console.error('Error:', error);
            return texts.map(() => "Translation Error");
        }
    }

    async function performTranslation() {
        const sourceText = document.getElementById('sourceText').value.trim();
        if (!sourceText) return alert('Please enter text to translate.');

        const lines = sourceText.split('\n').map(line => line.trim()).filter(line => line);
        const selectedLanguages = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
            .map(checkbox => supportedLanguages.find(lang => lang.id === checkbox.id));

        if (selectedLanguages.length === 0) return alert('Please select at least one language.');

        const resultTable = document.getElementById('resultTable');
        resultTable.innerHTML = '';
        document.getElementById('downloadButton').style.display = 'none';

        const zip = new JSZip();
        let completedTranslations = 0;

        for (const language of selectedLanguages) {
            const translations = await translateBatch(language.value, lines.map(line => {
                const match = line.match(/<string name="(.+?)">(.+)<\/string>/);
                return match ? match[2] : '';
            }));

            const translatedLines = lines.map((line, index) => {
                const match = line.match(/<string name="(.+?)">(.+)<\/string>/);
                if (!match) return line;
                const nameAttr = match[1];
                const translatedText = (translations[index] || "Translation Failed").replace(/"/g, '&quot;').replace(/'/g, "\\'");
                return `<string name="${nameAttr}">${translatedText}</string>`;
            });

            const fileContent = `<?xml version="1.0" encoding="utf-8"?>\n<resources>\n${translatedLines.join('\n')}\n</resources>`;
            zip.folder(folderLanguages[language.value]).file("strings.xml", fileContent);

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${language.id} <button onclick="copyToClipboard('${language.id}')">Copy</button></td>
                <td><pre id="content-${language.id}">${fileContent}</pre></td>
            `;
            resultTable.appendChild(row);

            completedTranslations++;
        }

        document.getElementById('downloadButton').style.display = 'block';
        document.getElementById('downloadButton').onclick = () => {
            zip.generateAsync({ type: 'blob' }).then(content => {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(content);
                a.download = 'translations.zip';
                a.click();
            });
        };
    }
</script>
